C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 15:36:18 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          /***********************************************
   2          基于STC15F2K60S2系列单片机C语言编程实现
   3          使用如下头文件，不用另外再包含"REG51.H"
   4          #include <STC15F2K60S2.h>
   5          ***********************************************/
   6          #include "sys_fun.h"
   7          #include "songs.h"
   8          #include "display.h"
   9          #include "sing.h"
  10          #include "string.h"
  11          
  12          uchar port_status;
  13          uchar key;
  14          unsigned char Count;
  15          double pitch = 7;
  16          char pitchFlag = 1;
  17          char currentPage = 1;
  18          unsigned char RECORDED[500];
  19          unsigned char SheetMid[500];
  20          unsigned char SheetUp[500];
  21          unsigned char SheetDown[500];
  22          
  23          
  24          
  25          int lastStartCount = -1;
  26          int lastEndCount = 0;
  27          uchar lastNote = 0x00;
  28          
  29          void Time0_Int() interrupt 1
  30          {
  31   1         TH0 = 0xDC;
  32   1         TL0 = 0x00;
  33   1         Count++;   
  34   1      }
  35          
  36          void Playnote(uchar flag, int i){
  37   1        OPT_CHECK = 0xFF;
  38   1        while (OPT_CHECK&flag){
  39   2          bee_Speak = ~bee_Speak;
  40   2          Delay_xMs(NOTE[i-1]);
  41   2          OPT_CHECK = 0xFF;
  42   2        }
  43   1        pitchFlag = 1;
  44   1      }
  45          
  46          void PlayMusic();
  47          void ManualPlay();
  48          void MenuDisplay(int);
  49          void Record();
  50          int Recordnote(uchar, int, int);
  51          void PlayRecord();
  52          void GetSheet(int);
  53          
  54          void main()
  55          {
C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 15:36:18 PAGE 2   

  56   1        P5M1=0x00;
  57   1        P5M0=0x30;
  58   1        
  59   1        P4M1=0xC0;
  60   1        P4M0=0x00;
  61   1        
  62   1        P3M1=0x00;
  63   1        P3M0=0x00;
  64   1        
  65   1        Ini_Lcd();//液晶初始化子程序
  66   1        Disp(1,0,16,"浙江大学光电学院");//显示数据到LCD12864子程序      
  67   1        Disp(2,1,12,"电子线路设计");//显示数据到LCD12864子程序
  68   1        Disp(3,2,8,"87951197");//显示数据到LCD12864子程序
  69   1        Disp(4,1,12,"液晶显示成功");//显示数据到LCD12864子程序*/
  70   1        while(1)
  71   1        {
  72   2          s1_s2_check();
  73   2          P4M1=0x00;
  74   2          P4M0=0x00;
  75   2          Ini_Lcd();//液晶初始化子程序
  76   2          MenuDisplay(currentPage);
  77   2          KeyIO = 0xF0;
  78   2          while(1){
  79   3            s1_s2_check();
  80   3            if ((P1&0xF0)!=0xF0){
  81   4              Delay_xMs(100);
  82   4              if((KeyIO&0xF0)!=0xF0){
  83   5                key = scankey();
  84   5                switch (key)
  85   5                {
  86   6                case 11:
  87   6                  PlayMusic();
  88   6                  MenuDisplay(currentPage);
  89   6                  break;
  90   6                case 12:
  91   6                  ManualPlay();
  92   6                  MenuDisplay(currentPage);
  93   6                  break;
  94   6                case 13:
  95   6                  currentPage ++;
  96   6                  MenuDisplay(currentPage);
  97   6                  break;
  98   6                case 14:
  99   6                  Record();
 100   6                  MenuDisplay(currentPage);
 101   6                  break;
 102   6                case 21:
 103   6                  PlayRecord();
 104   6                  MenuDisplay(currentPage);
 105   6                  break;
 106   6                case 22:
 107   6                  currentPage --;
 108   6                  MenuDisplay(currentPage);
 109   6                  break;
 110   6                default:
 111   6                  break;
 112   6                }
 113   5              }
 114   4              Delay_xMs(2500);
 115   4            }
 116   3          }
 117   2          Delay_xMs(2500);    
C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 15:36:18 PAGE 3   

 118   2        }
 119   1      }
 120          
 121          /*******************定时器初始化********************/
 122          void Time0_Init()
 123          {
 124   1       TMOD = 0x01;
 125   1       IE   = 0x82;
 126   1       TH0  = 0xDC;
 127   1       TL0  = 0x00;  //11.0592MZ
 128   1      }
 129          /****************播放音乐*************************/
 130          void s1_s2_check(void)
 131          {
 132   1        if(P4&0x40) 
 133   1          DLED_1 =1;
 134   1        else  
 135   1          DLED_1 =0;
 136   1        if((P4&0x80)) 
 137   1          DLED_2 =1;
 138   1        else  
 139   1          DLED_2 =0;
 140   1      }
 141          
 142          /****************播放音乐*************************/
 143          void Play_Song(unsigned char i)
 144          {
 145   1         unsigned char Temp1,Temp2;
 146   1         unsigned int Addr;
 147   1         Count = 0;      
 148   1         Addr = i * 217;  
 149   1         while(1)
 150   1         {
 151   2          
 152   2             Temp1 = SONG[Addr++];
 153   2             if ( Temp1 == 0xFF )         
 154   2             {
 155   3                TR0 = 0;                 
 156   3                Delay_xMs(100);
 157   3             }
 158   2             else if ( Temp1 == 0x00 )   
 159   2             {
 160   3                return;
 161   3             }
 162   2             else
 163   2             {
 164   3                Temp2 = SONG[Addr++];
 165   3                TR0 = 1;
 166   3              while(1)
 167   3              {
 168   4                 bee_Speak = ~bee_Speak;
 169   4                 Delay_xMs(Temp1);
 170   4                 if ( Temp2 == Count )
 171   4                 {
 172   5                    Count = 0;
 173   5                    break;
 174   5                 }
 175   4               KeyIO=0xF0;
 176   4               if ((P1&0xf0)!=0xf0) return;
 177   4              }
 178   3             }
 179   2        }
C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 15:36:18 PAGE 4   

 180   1        bee_Speak = 0;  //关闭蜂鸣器
 181   1      }
 182          
 183          
 184          /*****************检测控制端口的状态*****************/
 185          uchar ctrl_port_check(void)
 186          {
 187   1          SW_CTRL = 0xFF;
 188   1          return  SW_CTRL&0xF0;
 189   1      }
 190          
 191          uchar scankey(void)//矩阵键盘翻转扫描
 192          {
 193   1        uint keyvalue=0;
 194   1        uchar temp1,temp2,keycode;
 195   1      
 196   1        KeyIO=0xf0;   //行置0列置1
 197   1        temp1=KeyIO&0xf0;
 198   1        if((temp1&0xf0)==0xf0) return(0);  //若无键按下返回0
 199   1        KeyIO=0x0f;
 200   1        temp2=KeyIO&0x0f;            //若有键按下，行置1列置0
 201   1        keycode=~(temp1|temp2);        //获得键盘码
 202   1        switch(keycode)            //根据键盘码返回键值
 203   1        {
 204   2          case 0x11:return(11);break;
 205   2          case 0x21:return(12);break;
 206   2          case 0x41:return(13);break;
 207   2          case 0x81:return(14);break;
 208   2          case 0x12:return(21);break;
 209   2          case 0x22:return(22);break;
 210   2          case 0x42:return(23);break;
 211   2          case 0x82:return(24);break;
 212   2          case 0x14:return(31);break;
 213   2          case 0x24:return(32);break;
 214   2          case 0x44:return(33);break;
 215   2          case 0x84:return(34);break;
 216   2          case 0x18:return(41);break;
 217   2          case 0x28:return(42);break;
 218   2          case 0x48:return(43);break;
 219   2          case 0x88:return(44);break;
 220   2          default:  return(0);break;
 221   2        }
 222   1        return(0);
 223   1      }
 224             
 225          /****************延迟毫秒数************************/
 226          void Delay_xMs(unsigned int x)
 227          {
 228   1          unsigned int i,j;
 229   1          for( i = 0;i < x;i++ )
 230   1          {
 231   2              for( j = 0;j<2;j++ );
 232   2          }
 233   1      }
 234          
 235          // 菜单功能函数
 236          
 237          void MenuDisplay(int page){
 238   1        Ini_Lcd();
 239   1        switch (page)
 240   1        {
 241   2        case 1:
C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 15:36:18 PAGE 5   

 242   2          Disp(1,3,4,"菜单");
 243   2          Disp(2,0,10,"1.播放音乐");
 244   2          Disp(3,0,10,"2.弹奏模式");
 245   2          Disp(4,0,8,"3.下一页");
 246   2          break;
 247   2        case 2:
 248   2          Disp(1,3,4,"菜单");
 249   2          Disp(2,0,10,"4.录音模式");
 250   2          Disp(3,0,10,"5.播放录音");
 251   2          Disp(4,0,8,"6.上一页");
 252   2        default:
 253   2          break;
 254   2        }
 255   1      
 256   1      }
 257          
 258          void PlayMusic(){
 259   1        Ini_Lcd();
 260   1        Disp(1,2,8,"音乐播放");
 261   1        Disp(4,1,12,"按任意键返回");
 262   1        Time0_Init();
 263   1        Play_Song(0);
 264   1      }
 265          
 266          void ManualPlay(){
 267   1        s1_s2_check();
 268   1        Ini_Lcd();
 269   1        Disp(1,2,8,"演奏模式");
 270   1        if (pitch!=0) Disp(2,0,10,"2.降低音高");
 271   1        if (pitch!=14) Disp(3,0,10,"3.提高音高");
 272   1        Disp(4,1,12,"按任意键返回");
 273   1        while(1) {
 274   2          KeyIO=0xF0;
 275   2          if ((P1&0xf0)!=0xf0) {
 276   3            Delay_xMs(100);
 277   3            if((KeyIO&0xF0)!=0xF0){
 278   4              key = scankey();
 279   4              switch (key){
 280   5                case 12:
 281   5                  if (!pitchFlag) break;
 282   5                  if (pitch>0) pitch-=7;
 283   5                  if (pitch==0) Disp(2,0,16,"音高已经是最低了");
 284   5                  Disp(3,0,10,"3.提高音高");
 285   5                  pitchFlag = 0;
 286   5                  break;
 287   5                case 13:
 288   5                  if (!pitchFlag) break;
 289   5                  if (pitch<14) pitch+=7;
 290   5                  if (pitch==14) Disp(3,0,16,"音高已经是最高了");
 291   5                  Disp(2,0,10,"2.降低音高");
 292   5                  pitchFlag = 0;
 293   5                  break;
 294   5                default:
 295   5                  return;
 296   5                  break;
 297   5              }
 298   4            }
 299   3            Delay_xMs(100);
 300   3          }
 301   2          OPT_CHECK = 0xFF;
 302   2          if (OPT_CHECK&0x01) Playnote(0x01, 7+pitch);
 303   2           else if (OPT_CHECK&0x02) Playnote(0x02, 6+pitch);
C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 15:36:18 PAGE 6   

 304   2           else if (OPT_CHECK&0x04) Playnote(0x04, 5+pitch);
 305   2           else if (OPT_CHECK&0x08) Playnote(0x08, 4+pitch);
 306   2           else if (OPT_CHECK&0x10) Playnote(0x10, 3+pitch);
 307   2           else if (OPT_CHECK&0x20) Playnote(0x20, 2+pitch);
 308   2           else if (OPT_CHECK&0x40) Playnote(0x40, 1+pitch);  
 309   2        }
 310   1      }
 311          
 312          void Record(){
 313   1        char continueFlag = 0;
 314   1        int currentIndex = 0;
 315   1        lastEndCount = 0;
 316   1        lastStartCount = -1;
 317   1        lastNote = 0x00;
 318   1      
 319   1        s1_s2_check();
 320   1        Ini_Lcd();
 321   1        Disp(1,2,8,"录音模式");
 322   1        Disp(2,0,10,"1.开始录音");
 323   1        
 324   1        Disp(4,1,12,"按其他键返回");
 325   1        
 326   1        while(!continueFlag) {
 327   2          KeyIO=0xF0;
 328   2          if ((P1&0xf0)!=0xf0) {
 329   3            Delay_xMs(100);
 330   3            if((KeyIO&0xF0)!=0xF0){
 331   4              key = scankey();
 332   4              switch (key){
 333   5                case 11: continueFlag = 1;break;
 334   5                default: return;
 335   5              }
 336   4            }
 337   3            Delay_xMs(100);
 338   3          }
 339   2        }
 340   1        memset(RECORDED,0x00,sizeof(RECORDED));
 341   1        Disp(2,0,6,"录音中");
 342   1        Disp(3,0,10,"2.结束录音");
 343   1        Count = 0;
 344   1        Time0_Init();
 345   1        while(1){
 346   2          KeyIO=0xF0;
 347   2          if ((P1&0xf0)!=0xf0) {
 348   3            Delay_xMs(100);
 349   3            if((KeyIO&0xF0)!=0xF0){
 350   4              key = scankey();
 351   4              switch (key){
 352   5                case 12: 
 353   5                  Disp(3,0,8,"录音完成");
 354   5                  RECORDED[currentIndex] = lastNote;
 355   5                  RECORDED[currentIndex+1] = lastEndCount - lastStartCount; 
 356   5                  return;
 357   5                default: return;
 358   5              }
 359   4            }
 360   3            Delay_xMs(100);
 361   3          }
 362   2          OPT_CHECK = 0xFF;
 363   2          if (OPT_CHECK&0x01) currentIndex = Recordnote(0x01, 7+pitch, currentIndex);
 364   2           else if (OPT_CHECK&0x02) currentIndex  = Recordnote(0x02, 6+pitch, currentIndex);
 365   2           else if (OPT_CHECK&0x04) currentIndex  = Recordnote(0x04, 5+pitch, currentIndex);
C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 15:36:18 PAGE 7   

 366   2           else if (OPT_CHECK&0x08) currentIndex  = Recordnote(0x08, 4+pitch, currentIndex);
 367   2           else if (OPT_CHECK&0x10) currentIndex  = Recordnote(0x10, 3+pitch, currentIndex);
 368   2           else if (OPT_CHECK&0x20) currentIndex  = Recordnote(0x20, 2+pitch, currentIndex);
 369   2           else if (OPT_CHECK&0x40) currentIndex  = Recordnote(0x40, 1+pitch, currentIndex);  
 370   2        }
 371   1        
 372   1      }
 373          
 374          int Recordnote(uchar flag, int i, int index){
 375   1        if (lastStartCount != -1){
 376   2          RECORDED[index] = lastNote;
 377   2          RECORDED[index+1] = Count - lastStartCount;
 378   2        }
 379   1        OPT_CHECK = 0xFF;
 380   1        lastStartCount = Count;
 381   1        while (OPT_CHECK&flag){
 382   2          bee_Speak = ~bee_Speak;
 383   2          Delay_xMs(NOTE[i-1]);
 384   2          OPT_CHECK = 0xFF;
 385   2        }
 386   1        lastEndCount = Count;
 387   1        lastNote = NOTE[i-1];
 388   1        return index+2;
 389   1      }
 390          
 391          void PlayRecord()
 392          {
 393   1        unsigned char Temp1,Temp2;
 394   1        unsigned int Addr;
 395   1      
 396   1        s1_s2_check();
 397   1        Ini_Lcd();
 398   1        Disp(1,2,8,"播放录音");
 399   1        Disp(4,1,12,"按任意键返回");
 400   1      
 401   1        Count = 0;      
 402   1        Time0_Init();
 403   1        Addr = 0;  
 404   1        while(1)
 405   1        {
 406   2          Temp1 = RECORDED[Addr++];
 407   2            if ( Temp1 == 0xFF )  
 408   2            {
 409   3              TR0 = 0;                 
 410   3              Delay_xMs(100);
 411   3            }
 412   2            else if ( Temp1 == 0x00 )   
 413   2            {
 414   3              return;
 415   3            }
 416   2            else
 417   2            {
 418   3              Temp2 = RECORDED[Addr++];
 419   3              TR0 = 1;
 420   3            while(1)
 421   3            {
 422   4                bee_Speak = ~bee_Speak;
 423   4                Delay_xMs(Temp1);
 424   4                if ( Temp2 == Count )
 425   4                {
 426   5                   Count = 0;
 427   5                   break;
C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 15:36:18 PAGE 8   

 428   5                }
 429   4              KeyIO=0xF0;
 430   4              if ((P1&0xf0)!=0xf0) return;
 431   4            }
 432   3            }
 433   2        }
 434   1        bee_Speak = 0;  //关闭蜂鸣器
 435   1      }
 436          
 437          void getSheet(int start){
 438   1        unsigned char Temp1,Temp2;
 439   1        unsigned int Addr, INDEX;
 440   1      
 441   1        Addr = 0; INDEX = 0;
 442   1        Temp1 = RECORDED[Addr];
 443   1        while (Temp1 != 0x00){
 444   2          switch (Temp1){
 445   3            case 0x60,0x30,0x18:
 446   3              SheetMid[INDEX] = '1';
 447   3              break;
 448   3            case 0x56,0x2b,0x15:
 449   3              SheetMid[INDEX] = '2';
 450   3              break;
 451   3            case 0x4C,0x26,0x13:
 452   3              SheetMid[INDEX] = '3';
 453   3              break;
 454   3            case 0x48,0x24,0x12:
 455   3              SheetMid[INDEX] = '4';
 456   3              break;
 457   3            case 0x40,0x20,0x10:
 458   3              SheetMid[INDEX] = '5';
 459   3              break;
 460   3            case 0x38,0x1C,0x0E:
 461   3              SheetMid[INDEX] = '6';
 462   3              break;
 463   3            case 0x32,0x19,0x0D:
 464   3              SheetMid[INDEX] = '7';
 465   3              break;
 466   3            default:
 467   3              break;
 468   3          }
 469   2          if (Temp1>=0x32){
 470   3            SheetDown[INDEX] = '.';
 471   3            SheetUp[INDEX] = ' ';
 472   3          } else if (Temp1<=0x18){
 473   3            SheetUp[INDEX] = ' ';
 474   3            SheetDown[INDEX] = ' ';
 475   3          } else {
 476   3            SheetUp[INDEX] = SheetDown[INDEX] = ' ';
 477   3          }
 478   2        }
 479   1      }
*** WARNING C280 IN LINE 437 OF main.c: 'start': unreferenced local variable
*** WARNING C280 IN LINE 438 OF main.c: 'Temp2': unreferenced local variable
*** WARNING C294 IN LINE 117 OF main.c: unreachable code
*** WARNING C294 IN LINE 180 OF main.c: unreachable code
*** WARNING C294 IN LINE 222 OF main.c: unreachable code
*** WARNING C294 IN LINE 434 OF main.c: unreachable code


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3085    ----
C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 15:36:18 PAGE 9   

   CONSTANT SIZE    =    463    ----
   XDATA SIZE       =   2040      26
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  6 WARNING(S),  0 ERROR(S)
