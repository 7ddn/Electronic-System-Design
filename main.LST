C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 20:23:57 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          /***********************************************
   2          基于STC15F2K60S2系列单片机C语言编程实现
   3          使用如下头文件，不用另外再包含"REG51.H"
   4          #include <STC15F2K60S2.h>
   5          ***********************************************/
   6          #include "sys_fun.h"
   7          #include "songs.h"
   8          #include "display.h"
   9          #include "sing.h"
  10          #include "string.h"
  11          
  12          uchar port_status;
  13          uchar key;
  14          unsigned char Count;
  15          double pitch = 7;
  16          char pitchFlag = 1;
  17          char currentPage = 1;
  18          unsigned char RECORDED[250];
  19          unsigned char SheetMid[250];
  20          unsigned char SheetUp[250];
  21          unsigned char SheetDown[250];
  22          unsigned int Sheet2Note[250];
  23          
  24          
  25          
  26          int lastStartCount = -1;
  27          int lastEndCount = 0;
  28          uchar lastNote = 0x00;
  29          
  30          void Time0_Int() interrupt 1
  31          {
  32   1         TH0 = 0xDC;
  33   1         TL0 = 0x00;
  34   1         Count++;   
  35   1      }
  36          
  37          void Playnote(uchar flag, int i){
  38   1        OPT_CHECK = 0xFF;
  39   1        while (OPT_CHECK&flag){
  40   2          bee_Speak = ~bee_Speak;
  41   2          Delay_xMs(NOTE[i-1]);
  42   2          OPT_CHECK = 0xFF;
  43   2        }
  44   1        pitchFlag = 1;
  45   1      }
  46          
  47          void PlayMusic();
  48          void ManualPlay();
  49          void MenuDisplay(int);
  50          void Record();
  51          int Recordnote(uchar, int, int);
  52          void PlayRecord();
  53          void GetSheet(int);
  54          
  55          void main()
C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 20:23:57 PAGE 2   

  56          {
  57   1        P5M1=0x00;
  58   1        P5M0=0x30;
  59   1        
  60   1        P4M1=0xC0;
  61   1        P4M0=0x00;
  62   1        
  63   1        P3M1=0x00;
  64   1        P3M0=0x00;
  65   1        
  66   1        Ini_Lcd();//液晶初始化子程序
  67   1        Disp(1,0,16,"浙江大学光电学院");//显示数据到LCD12864子程序      
  68   1        Disp(2,1,12,"电子线路设计");//显示数据到LCD12864子程序
  69   1        Disp(3,2,8,"87951197");//显示数据到LCD12864子程序
  70   1        Disp(4,1,12,"液晶显示成功");//显示数据到LCD12864子程序*/
  71   1        while(1)
  72   1        {
  73   2          s1_s2_check();
  74   2          P4M1=0x00;
  75   2          P4M0=0x00;
  76   2          Ini_Lcd();//液晶初始化子程序
  77   2          MenuDisplay(currentPage);
  78   2          KeyIO = 0xF0;
  79   2          while(1){
  80   3            s1_s2_check();
  81   3            if ((P1&0xF0)!=0xF0){
  82   4              Delay_xMs(100);
  83   4              if((KeyIO&0xF0)!=0xF0){
  84   5                key = scankey();
  85   5                switch (key)
  86   5                {
  87   6                case 11:
  88   6                  PlayMusic();
  89   6                  bee_Speak = 0;
  90   6                  MenuDisplay(currentPage);
  91   6                  break;
  92   6                case 12:
  93   6                  ManualPlay();
  94   6                  MenuDisplay(currentPage);
  95   6                  break;
  96   6                case 13:
  97   6                  currentPage ++;
  98   6                  MenuDisplay(currentPage);
  99   6                  break;
 100   6                case 14:
 101   6                  Record();
 102   6                  MenuDisplay(currentPage);
 103   6                  break;
 104   6                case 21:
 105   6                  PlayRecord();
 106   6                  MenuDisplay(currentPage);
 107   6                  break;
 108   6                case 22:
 109   6                  currentPage --;
 110   6                  MenuDisplay(currentPage);
 111   6                  break;
 112   6                default:
 113   6                  break;
 114   6                }
 115   5              }
 116   4              Delay_xMs(2500);
 117   4            }
C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 20:23:57 PAGE 3   

 118   3          }
 119   2          Delay_xMs(2500);    
 120   2        }
 121   1      }
 122          
 123          /*******************定时器初始化********************/
 124          void Time0_Init()
 125          {
 126   1       TMOD = 0x01;
 127   1       IE   = 0x82;
 128   1       TH0  = 0xDC;
 129   1       TL0  = 0x00;  //11.0592MZ
 130   1      }
 131          /****************播放音乐*************************/
 132          void s1_s2_check(void)
 133          {
 134   1        if(P4&0x40) 
 135   1          DLED_1 =1;
 136   1        else  
 137   1          DLED_1 =0;
 138   1        if((P4&0x80)) 
 139   1          DLED_2 =1;
 140   1        else  
 141   1          DLED_2 =0;
 142   1      }
 143          
 144          /****************播放音乐*************************/
 145          void Play_Song(unsigned char i)
 146          {
 147   1        unsigned char Temp1,Temp2;
 148   1        unsigned int Addr,start;
 149   1        unsigned int lineCount, loc;
 150   1        unsigned char lrc[20];
 151   1      
 152   1        lineCount = 1;
 153   1        loc = 0;
 154   1        start = INDEX[i];
 155   1        Addr = start;  
 156   1        GetSheet(Addr);
 157   1        
 158   1        strncpy(lrc,  SheetUp, 16);
 159   1        Disp(2,0,16,lrc);
 160   1        strncpy(lrc, SheetMid, 16);
 161   1        Disp(3,0,16,lrc);
 162   1        strncpy(lrc, SheetDown, 16);
 163   1        Disp(4,0,16,lrc);
 164   1        Count = 0;    
 165   1      
 166   1        while(1)
 167   1        {
 168   2          
 169   2          Temp1 = SONG[Addr++];
 170   2            if ( Temp1 == 0xFF )
 171   2            {
 172   3              TR0 = 0;                 
 173   3              Delay_xMs(100);
 174   3            }
 175   2            else if ( Temp1 == 0x00 )   
 176   2            {
 177   3              return;
 178   3            }
 179   2            else
C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 20:23:57 PAGE 4   

 180   2            {
 181   3              Temp2 = SONG[Addr++];
 182   3              TR0 = 1;
 183   3            while(1)
 184   3            {
 185   4                bee_Speak = ~bee_Speak;
 186   4                Delay_xMs(Temp1);
 187   4                if ( Temp2 == Count )
 188   4                {
 189   5                if (Sheet2Note[Addr - start] > lineCount*16){
 190   6                  loc = loc + 16;
 191   6                  lineCount++;
 192   6                  strncpy(lrc, SheetUp+loc, 16);
 193   6                  Disp(2,0,16,lrc);
 194   6                  strncpy(lrc, SheetMid+loc, 16);
 195   6                  Disp(3,0,16,lrc);
 196   6                  strncpy(lrc, SheetDown+loc, 16);
 197   6                  Disp(4,0,16,lrc);
 198   6                }
 199   5                    Count = 0;
 200   5                    break;
 201   5                }
 202   4              KeyIO=0xF0;
 203   4              if ((P1&0xf0)!=0xf0) return;
 204   4            }
 205   3            }
 206   2        }
 207   1        bee_Speak = 0;  //关闭蜂鸣器
 208   1      }
 209          
 210          
 211          /*****************检测控制端口的状态*****************/
 212          uchar ctrl_port_check(void)
 213          {
 214   1          SW_CTRL = 0xFF;
 215   1          return  SW_CTRL&0xF0;
 216   1      }
 217          
 218          uchar scankey(void)//矩阵键盘翻转扫描
 219          {
 220   1        uint keyvalue=0;
 221   1        uchar temp1,temp2,keycode;
 222   1      
 223   1        KeyIO=0xf0;   //行置0列置1
 224   1        temp1=KeyIO&0xf0;
 225   1        if((temp1&0xf0)==0xf0) return(0);  //若无键按下返回0
 226   1        KeyIO=0x0f;
 227   1        temp2=KeyIO&0x0f;            //若有键按下，行置1列置0
 228   1        keycode=~(temp1|temp2);        //获得键盘码
 229   1        switch(keycode)            //根据键盘码返回键值
 230   1        {
 231   2          case 0x11:return(11);break;
 232   2          case 0x21:return(12);break;
 233   2          case 0x41:return(13);break;
 234   2          case 0x81:return(14);break;
 235   2          case 0x12:return(21);break;
 236   2          case 0x22:return(22);break;
 237   2          case 0x42:return(23);break;
 238   2          case 0x82:return(24);break;
 239   2          case 0x14:return(31);break;
 240   2          case 0x24:return(32);break;
 241   2          case 0x44:return(33);break;
C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 20:23:57 PAGE 5   

 242   2          case 0x84:return(34);break;
 243   2          case 0x18:return(41);break;
 244   2          case 0x28:return(42);break;
 245   2          case 0x48:return(43);break;
 246   2          case 0x88:return(44);break;
 247   2          default:  return(0);break;
 248   2        }
 249   1        return(0);
 250   1      }
 251             
 252          /****************延迟毫秒数************************/
 253          void Delay_xMs(unsigned int x)
 254          {
 255   1          unsigned int i,j;
 256   1          for( i = 0;i < x;i++ )
 257   1          {
 258   2              for( j = 0;j<2;j++ );
 259   2          }
 260   1      }
 261          
 262          // 菜单功能函数
 263          
 264          void MenuDisplay(int page){
 265   1        Ini_Lcd();
 266   1        switch (page)
 267   1        {
 268   2        case 1:
 269   2          Disp(1,3,4,"菜单");
 270   2          Disp(2,0,10,"1.播放音乐");
 271   2          Disp(3,0,10,"2.弹奏模式");
 272   2          Disp(4,0,8,"3.下一页");
 273   2          break;
 274   2        case 2:
 275   2          Disp(1,3,4,"菜单");
 276   2          Disp(2,0,10,"4.录音模式");
 277   2          Disp(3,0,10,"5.播放录音");
 278   2          Disp(4,0,8,"6.上一页");
 279   2        default:
 280   2          break;
 281   2        }
 282   1      
 283   1      }
 284          
 285          void PlayMusic(){
 286   1        Ini_Lcd();
 287   1        Disp(1,0,8,"1.新宝岛");
 288   1        Disp(2,0,6,"2.爱河");
 289   1        Disp(3,0,10,"3.祝你平安");
 290   1        Disp(4,0,10,"4.天空之城");
 291   1      
 292   1        Time0_Init();
 293   1        KeyIO = 0xF0;
 294   1        while(1){
 295   2          s1_s2_check();
 296   2          if ((P1&0xF0)!=0xF0){
 297   3            Delay_xMs(100);
 298   3            if((KeyIO&0xF0)!=0xF0){
 299   4              key = scankey();
 300   4              switch (key)
 301   4              {
 302   5              case 11:
 303   5                Ini_Lcd();
C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 20:23:57 PAGE 6   

 304   5                Disp(1,0,8,"1.新宝岛");
 305   5                Play_Song(0);
 306   5                return;
 307   5                break;
 308   5              case 12:
 309   5                Ini_Lcd();
 310   5                Disp(1,0,6,"2.爱河");
 311   5                Play_Song(1);
 312   5                return;
 313   5                break;
 314   5              case 13:
 315   5                Ini_Lcd();
 316   5                Disp(1,0,10,"3.祝你平安");
 317   5                Play_Song(2);
 318   5                return;
 319   5                break;
 320   5              case 14:
 321   5                Ini_Lcd();
 322   5                Disp(1,0,10,"4.天空之城");
 323   5                Play_Song(3);
 324   5                return;
 325   5                break;
 326   5              default:
 327   5                return;
 328   5                break;
 329   5              }
 330   4            }
 331   3            Delay_xMs(2500);
 332   3          }
 333   2        }
 334   1      }
 335          
 336          void ManualPlay(){
 337   1        s1_s2_check();
 338   1        Ini_Lcd();
 339   1        Disp(1,2,8,"演奏模式");
 340   1        if (pitch!=0) Disp(2,0,10,"2.降低音高");
 341   1        if (pitch!=14) Disp(3,0,10,"3.提高音高");
 342   1        Disp(4,1,12,"按任意键返回");
 343   1        while(1) {
 344   2          KeyIO=0xF0;
 345   2          if ((P1&0xf0)!=0xf0) {
 346   3            Delay_xMs(100);
 347   3            if((KeyIO&0xF0)!=0xF0){
 348   4              key = scankey();
 349   4              switch (key){
 350   5                case 12:
 351   5                  if (!pitchFlag) break;
 352   5                  if (pitch>0) pitch-=7;
 353   5                  if (pitch==0) Disp(2,0,16,"音高已经是最低了");
 354   5                  Disp(3,0,10,"3.提高音高");
 355   5                  pitchFlag = 0;
 356   5                  break;
 357   5                case 13:
 358   5                  if (!pitchFlag) break;
 359   5                  if (pitch<14) pitch+=7;
 360   5                  if (pitch==14) Disp(3,0,16,"音高已经是最高了");
 361   5                  Disp(2,0,10,"2.降低音高");
 362   5                  pitchFlag = 0;
 363   5                  break;
 364   5                default:
 365   5                  return;
C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 20:23:57 PAGE 7   

 366   5                  break;
 367   5              }
 368   4            }
 369   3            Delay_xMs(100);
 370   3          }
 371   2          OPT_CHECK = 0xFF;
 372   2          if (OPT_CHECK&0x01) Playnote(0x01, 7+pitch);
 373   2           else if (OPT_CHECK&0x02) Playnote(0x02, 6+pitch);
 374   2           else if (OPT_CHECK&0x04) Playnote(0x04, 5+pitch);
 375   2           else if (OPT_CHECK&0x08) Playnote(0x08, 4+pitch);
 376   2           else if (OPT_CHECK&0x10) Playnote(0x10, 3+pitch);
 377   2           else if (OPT_CHECK&0x20) Playnote(0x20, 2+pitch);
 378   2           else if (OPT_CHECK&0x40) Playnote(0x40, 1+pitch);  
 379   2        }
 380   1      }
 381          
 382          // 录制
 383          
 384          void Record(){
 385   1        char continueFlag = 0;
 386   1        int currentIndex = 0;
 387   1        lastEndCount = 0;
 388   1        lastStartCount = -1;
 389   1        lastNote = 0x00;
 390   1      
 391   1        s1_s2_check();
 392   1        Ini_Lcd();
 393   1        Disp(1,2,8,"录音模式");
 394   1        Disp(2,0,10,"1.开始录音");
 395   1        
 396   1        Disp(4,1,12,"按其他键返回");
 397   1        
 398   1        while(!continueFlag) {
 399   2          KeyIO=0xF0;
 400   2          if ((P1&0xf0)!=0xf0) {
 401   3            Delay_xMs(100);
 402   3            if((KeyIO&0xF0)!=0xF0){
 403   4              key = scankey();
 404   4              switch (key){
 405   5                case 11: continueFlag = 1;break;
 406   5                default: return;
 407   5              }
 408   4            }
 409   3            Delay_xMs(100);
 410   3          }
 411   2        }
 412   1        memset(RECORDED,0x00,sizeof(RECORDED));
 413   1        Disp(2,0,6,"录音中");
 414   1        Disp(3,0,10,"2.结束录音");
 415   1        Count = 0;
 416   1        Time0_Init();
 417   1        while(1){
 418   2          KeyIO=0xF0;
 419   2          if ((P1&0xf0)!=0xf0) {
 420   3            Delay_xMs(100);
 421   3            if((KeyIO&0xF0)!=0xF0){
 422   4              key = scankey();
 423   4              switch (key){
 424   5                case 12: 
 425   5                  Disp(3,0,8,"录音完成");
 426   5                  RECORDED[currentIndex] = lastNote;
 427   5                  RECORDED[currentIndex+1] = lastEndCount - lastStartCount; 
C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 20:23:57 PAGE 8   

 428   5                  return;
 429   5                default: return;
 430   5              }
 431   4            }
 432   3            Delay_xMs(100);
 433   3          }
 434   2          OPT_CHECK = 0xFF;
 435   2          if (OPT_CHECK&0x01) currentIndex = Recordnote(0x01, 7+pitch, currentIndex);
 436   2           else if (OPT_CHECK&0x02) currentIndex  = Recordnote(0x02, 6+pitch, currentIndex);
 437   2           else if (OPT_CHECK&0x04) currentIndex  = Recordnote(0x04, 5+pitch, currentIndex);
 438   2           else if (OPT_CHECK&0x08) currentIndex  = Recordnote(0x08, 4+pitch, currentIndex);
 439   2           else if (OPT_CHECK&0x10) currentIndex  = Recordnote(0x10, 3+pitch, currentIndex);
 440   2           else if (OPT_CHECK&0x20) currentIndex  = Recordnote(0x20, 2+pitch, currentIndex);
 441   2           else if (OPT_CHECK&0x40) currentIndex  = Recordnote(0x40, 1+pitch, currentIndex);  
 442   2        }
 443   1        
 444   1      }
 445          
 446          //音符录制
 447          
 448          int Recordnote(uchar flag, int i, int index){
 449   1        if (lastStartCount != -1){
 450   2          RECORDED[index] = lastNote;
 451   2          RECORDED[index+1] = Count - lastStartCount;
 452   2        }
 453   1        OPT_CHECK = 0xFF;
 454   1        lastStartCount = Count;
 455   1        while (OPT_CHECK&flag){
 456   2          bee_Speak = ~bee_Speak;
 457   2          Delay_xMs(NOTE[i-1]);
 458   2          OPT_CHECK = 0xFF;
 459   2        }
 460   1        lastEndCount = Count;
 461   1        lastNote = NOTE[i-1];
 462   1        return index+2;
 463   1      }
 464          
 465          // 录音播放
 466          
 467          void PlayRecord()
 468          {
 469   1        unsigned char Temp1,Temp2;
 470   1        unsigned int Addr;
 471   1      
 472   1        s1_s2_check();
 473   1        Ini_Lcd();
 474   1        Disp(1,2,8,"播放录音");
 475   1        Disp(4,1,12,"按任意键返回");
 476   1      
 477   1             
 478   1        Time0_Init();
 479   1        Addr = 2;  
 480   1        Count = 0; 
 481   1        while(1)
 482   1        {
 483   2          Temp1 = RECORDED[Addr++];
 484   2            if ( Temp1 == 0xFF )  
 485   2            {
 486   3              TR0 = 0;                 
 487   3              Delay_xMs(100);
 488   3            }
 489   2            else if ( Temp1 == 0x00 )   
C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 20:23:57 PAGE 9   

 490   2            {
 491   3              return;
 492   3            }
 493   2            else
 494   2            {
 495   3              Temp2 = RECORDED[Addr++];
 496   3              TR0 = 1;
 497   3            while(1)
 498   3            {
 499   4                bee_Speak = ~bee_Speak;
 500   4                Delay_xMs(Temp1);
 501   4                if ( Temp2 == Count )
 502   4                {
 503   5                   Count = 0;
 504   5                   break;
 505   5                }
 506   4              KeyIO=0xF0;
 507   4              if ((P1&0xf0)!=0xf0) return;
 508   4            }
 509   3            }
 510   2        }
 511   1        bee_Speak = 0;  //关闭蜂鸣器
 512   1      }
 513          
 514          // 简谱生成
 515          
 516          void GetSheet(int start){
 517   1        unsigned char Temp1,Temp2;
 518   1        unsigned int Addr, Index;
 519   1      
 520   1        Addr = start; Index = 0;
 521   1        Temp1 = SONG[Addr];
 522   1        while (Temp1 != 0x00){
 523   2          Sheet2Note[Addr - start] = Index;
 524   2          switch (Temp1){
 525   3            case 0x60:
 526   3            case 0x30:
 527   3            case 0x18:
 528   3              SheetMid[Index] = '1';
 529   3              break;
 530   3            case 0x56:
 531   3            case 0x2b:
 532   3            case 0x15:
 533   3              SheetMid[Index] = '2';
 534   3              break;
 535   3            case 0x4C:
 536   3            case 0x26:
 537   3            case 0x13:
 538   3              SheetMid[Index] = '3';
 539   3              break;
 540   3            case 0x48:
 541   3            case 0x24:
 542   3            case 0x12:
 543   3              SheetMid[Index] = '4';
 544   3              break;
 545   3            case 0x40:
 546   3            case 0x20:
 547   3            case 0x10:
 548   3              SheetMid[Index] = '5';
 549   3              break;
 550   3            case 0x39:
 551   3            case 0x1C:
C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 20:23:57 PAGE 10  

 552   3            case 0x0E:
 553   3              SheetMid[Index] = '6';
 554   3              break;
 555   3            case 0x32:
 556   3            case 0x19:
 557   3            case 0x0D:
 558   3              SheetMid[Index] = '7';
 559   3              break;
 560   3            default:
 561   3              Addr++;
 562   3              Temp1 = SONG[Addr];
 563   3              continue;
 564   3              break;
 565   3          }
 566   2          if (Temp1 == 0xFF) continue;
 567   2          if (Temp1 >=0x32){
 568   3            SheetDown[Index] = '.';
 569   3            SheetUp[Index] = ' ';
 570   3          } else if (Temp1 <= 0x18){
 571   3            SheetUp[Index] = '.';
 572   3            SheetDown[Index] = ' ';
 573   3          } else {
 574   3            SheetUp[Index] = ' ';
 575   3            SheetDown[Index] = ' ';
 576   3          }
 577   2          Addr++;
 578   2          Temp2 = SONG[Addr];
 579   2          if (Temp2 == 0x20) {
 580   3            Addr++;
 581   3            Index++;
 582   3            Temp1 = SONG[Addr];
 583   3            continue;
 584   3          }
 585   2          else if (Temp2 == 0x10)
 586   2            SheetDown[Index] = '-';
 587   2          else if (Temp2 == 0x08)
 588   2            SheetDown[Index] = '=';
 589   2          else if (Temp2 == 0x30){
 590   3            Index++;
 591   3            SheetMid[Index] = '.';
 592   3            SheetDown[Index] = ' ';
 593   3            SheetUp[Index] = ' ';
 594   3          } else if (Temp2 >= 0x40){
 595   3            Temp2 = Temp2 - 0x20;
 596   3            while (Temp2 >= 0x20){
 597   4              Index++;
 598   4              SheetMid[Index] = '-';
 599   4              SheetDown[Index] = ' ';
 600   4              SheetUp[Index] = ' ';
 601   4              Temp2 = Temp2 - 0x20;
 602   4            }
 603   3          }
 604   2          Addr++;
 605   2          Index++;
 606   2          Temp1 = SONG[Addr];
 607   2        }
 608   1        return;
 609   1      }
*** WARNING C294 IN LINE 119 OF main.c: unreachable code
*** WARNING C294 IN LINE 207 OF main.c: unreachable code
*** WARNING C294 IN LINE 249 OF main.c: unreachable code
*** WARNING C294 IN LINE 511 OF main.c: unreachable code
C51 COMPILER V9.60.0.0   MAIN                                                              08/21/2020 20:23:57 PAGE 11  



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   4279    ----
   CONSTANT SIZE    =    997    ----
   XDATA SIZE       =   1543      55
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  4 WARNING(S),  0 ERROR(S)
